<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å®Œç¾é€‚é…æ’­æ”¾å™¨ï¼šæ—‹è½¬è¡¥é»‘+åŸå§‹æˆªå›¾</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; background: #1a1a1a; color: #ddd; text-align: center; margin: 0; padding: 20px; user-select: none; }
        
        /* 1. æ’­æ”¾å™¨å®¹å™¨ï¼šé»‘åº•ï¼Œå›ºå®šå°ºå¯¸ (æˆ–è‡ªé€‚åº”) */
        .player-wrap {
            position: relative;
            width: 800px;
            height: 450px;
            background: #000; /* å…³é”®ï¼šé»‘è‰²å¡«å…… */
            margin: 0 auto 10px;
            border: 1px solid #333;
            
            /* å…³é”®ï¼šä½¿ç”¨ Flex å±…ä¸­ï¼Œç¡®ä¿æ—‹è½¬åè§†é¢‘ä¾ç„¶æ‚¬æµ®åœ¨æ­£ä¸­é—´ */
            display: flex;
            align-items: center;
            justify-content: center;
            
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* 2. è§†é¢‘æ ‡ç­¾ */
        video {
            /* å…³é”®ï¼šè®©è§†é¢‘åˆå§‹çŠ¶æ€æœ€å¤§åŒ–é€‚åº”å®¹å™¨ï¼Œä½†ä¸å¼ºåˆ¶æ‹‰ä¼¸ */
            width: 100%;
            height: 100%;
            object-fit: contain; /* å…³é”®ï¼šä¿è¯0åº¦æ—¶ä¹Ÿæ˜¯ç´§è´´è¾¹ç¼˜+è¡¥é»‘ */
            
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: center center; /* å›´ç»•ä¸­å¿ƒæ—‹è½¬ */
        }

        /* è¿›åº¦æ¡ä¸æ§åˆ¶æ æ ·å¼ (ä¿æŒä¸å˜) */
        .progress-container { width: 800px; height: 10px; background: #444; margin: 0 auto 20px; position: relative; cursor: pointer; border-radius: 5px; transition: height 0.1s; }
        .progress-container:hover { height: 15px; }
        .progress-filled { height: 100%; background: #ff0000; width: 0%; border-radius: 5px; pointer-events: none; }
        
        .thumbnail-popup { position: absolute; bottom: 25px; left: 0; width: 160px; height: 90px; background: #000; border: 2px solid #fff; border-radius: 4px; display: none; pointer-events: none; z-index: 100; transform: translateX(-50%); }
        .thumbnail-popup canvas { width: 100%; height: 100%; object-fit: contain; background: #000;}
        .time-tooltip { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); color: #fff; font-size: 12px; }

        .controls { width: 800px; margin: 10px auto; background: #2a2a2a; padding: 15px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
        .file-upload { position: relative; overflow: hidden; display: inline-block; }
        .file-upload input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%;}
        
        button, .btn { padding: 8px 12px; cursor: pointer; background: #444; color: #fff; border: 1px solid #555; border-radius: 4px; }
        button:hover { background: #555; }
        .btn-primary { background: #007bff; border-color: #007bff; }
        
        /* æ¡†é€‰æ ·å¼ */
        .crop-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; cursor: crosshair; display: none; }
        .selection-box { border: 2px dashed #00ff00; background: rgba(0, 255, 0, 0.2); position: absolute; display: none; pointer-events: none; }

        #previewArea { margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; text-align: left; width: 800px; margin: 20px auto;}
        img.preview { border: 1px solid #fff; max-width: 150px; margin: 5px; vertical-align: top; background: #000; }
    </style>
</head>
<body>

<div class="player-wrap" id="playerContainer">
    <video id="myVideo"></video>
    <!-- æ¡†é€‰é®ç½© -->
    <div class="crop-overlay" id="cropOverlay">
        <div class="selection-box" id="selectionBox"></div>
    </div>
</div>

<!-- è¿›åº¦æ¡ -->
<div class="progress-container" id="progressWrap">
    <div class="progress-filled" id="progressFill"></div>
    <div class="thumbnail-popup" id="thumbPopup">
        <canvas id="thumbCanvas" width="160" height="90"></canvas>
        <div class="time-tooltip" id="thumbTime">00:00</div>
    </div>
</div>

<!-- æŒ‰é’®åŒº -->
<div class="controls">
    <div class="group">
        <div class="file-upload btn btn-primary">
            <span>ğŸ“‚ é€‰æ‹©æœ¬åœ°è§†é¢‘</span>
            <input type="file" id="fileInput" accept="video/*">
        </div>
    </div>

    <div class="group">
        <button onclick="playPause()">â¯ æ’­æ”¾/åœ</button>
        <button onclick="rotateVideo()">ğŸ”„ æ—‹è½¬ 90Â°(é€‚åº”å®¹å™¨)</button>
    </div>
    
    <div class="group">
        <button onclick="stepFrame(-1)">â® -1å¸§</button>
        <button onclick="stepFrame(1)">+1å¸§ â­</button>
    </div>

    <div class="group">
        <button onclick="takeRawSnapshot()" style="background:#28a745; border-color:#28a745">ğŸ“· åŸå§‹æˆªå›¾</button>
        <button onclick="toggleCropMode()" id="cropBtn">âœ‚ï¸ æ¡†é€‰(æ‰€è§å³æ‰€å¾—)</button>
    </div>
</div>

<div id="previewArea">
    <p style="color:#888; font-size:12px; margin:0 0 10px 0;">æˆªå›¾ç»“æœ:</p>
</div>

<script>
    const video = document.getElementById('myVideo');
    const container = document.getElementById('playerContainer');
    const ghostVideo = document.createElement('video'); // ç”¨äºé¢„è§ˆå›¾
    const fileInput = document.getElementById('fileInput');
    
    // UI å…ƒç´ 
    const progressWrap = document.getElementById('progressWrap');
    const progressFill = document.getElementById('progressFill');
    const thumbPopup = document.getElementById('thumbPopup');
    const thumbCtx = document.getElementById('thumbCanvas').getContext('2d');
    const thumbTime = document.getElementById('thumbTime');
    const cropOverlay = document.getElementById('cropOverlay');
    const selectionBox = document.getElementById('selectionBox');
    const cropBtn = document.getElementById('cropBtn');
    
    let currentDeg = 0;
    let isCropMode = false;
    let currentScale = 1; // è®°å½•å½“å‰çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä¾›æ¡†é€‰è®¡ç®—ç”¨
    let startX, startY, isDragging = false;
    let ghostSeeking = false;

    // --- 1. åŠ è½½è§†é¢‘ ---
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        video.src = url; video.load();
        ghostVideo.src = url; ghostVideo.muted = true;
        
        // é‡ç½®çŠ¶æ€
        currentDeg = 0;
        currentScale = 1;
        video.style.transform = 'rotate(0deg) scale(1)';
    });

    // --- 2. æ ¸å¿ƒï¼šæ—‹è½¬å¹¶å¼ºåˆ¶é€‚åº”å®¹å™¨ (Tight Fit) ---
    function rotateVideo() {
        if (!video.currentSrc) return;
        currentDeg = (currentDeg + 90) % 360;

        const cw = container.offsetWidth;
        const ch = container.offsetHeight;
        
        // å…³é”®ç®—æ³•ï¼š
        // å¦‚æœæ˜¯ 0 æˆ– 180 åº¦ï¼Œå®½é«˜æ¯”æ­£å¸¸ï¼Œscale = 1 (CSS object-fit ä¼šå¤„ç†)
        // å¦‚æœæ˜¯ 90 æˆ– 270 åº¦ï¼Œè§†é¢‘çš„å®½é«˜åœ¨è§†è§‰ä¸Šäº’æ¢äº†ã€‚
        // æˆ‘ä»¬éœ€è¦æŠŠ"ç«–ç€"çš„è§†é¢‘å¡è¿›"æ¨ªç€"çš„å®¹å™¨é‡Œï¼Œä¸”å¿…é¡»å…¨éƒ¨æ˜¾ç¤ºã€‚
        
        if (currentDeg % 180 !== 0) {
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼šå– (å®¹å™¨å®½/å®¹å™¨é«˜) å’Œ (å®¹å™¨é«˜/å®¹å™¨å®½) è¾ƒå°çš„ä¸€ä¸ª
            // è¿™æ ·èƒ½ç¡®ä¿æ— è®ºå®¹å™¨æ˜¯æ‰çš„è¿˜æ˜¯é«˜çš„ï¼Œæ—‹è½¬åçš„è§†é¢‘éƒ½èƒ½å®Œå…¨ç¼©æ”¾è¿›å»
            currentScale = Math.min(cw / ch, ch / cw);
        } else {
            currentScale = 1;
        }

        video.style.transform = `rotate(${currentDeg}deg) scale(${currentScale})`; 
    }

    // --- 3. åŸå§‹æˆªå›¾ (ä¸å—æ—‹è½¬å½±å“) ---
    function takeRawSnapshot() {
        if (!video.currentSrc) return;
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        saveImage(canvas.toDataURL('image/png'), 'raw');
    }

    // --- 4. æ¡†é€‰æˆªå›¾ (æ‰€è§å³æ‰€å¾—) ---
    function toggleCropMode() {
        if (!video.currentSrc) return;
        isCropMode = !isCropMode;
        if (isCropMode) {
            cropOverlay.style.display = 'block'; video.pause();
            cropBtn.innerText = "âŒ å–æ¶ˆ"; cropBtn.style.background = "#d9534f";
        } else {
            cropOverlay.style.display = 'none'; selectionBox.style.display = 'none';
            cropBtn.innerText = "âœ‚ï¸ æ¡†é€‰"; cropBtn.style.background = "#444";
        }
    }
    
    // é¼ æ ‡æ‹–æ‹½é€»è¾‘
    cropOverlay.addEventListener('mousedown', (e) => {
        isDragging = true;
        const rect = cropOverlay.getBoundingClientRect();
        startX = e.clientX - rect.left; startY = e.clientY - rect.top;
        selectionBox.style.display = 'block'; selectionBox.style.width = '0'; selectionBox.style.height = '0';
        selectionBox.style.left = startX + 'px'; selectionBox.style.top = startY + 'px';
    });
    
    cropOverlay.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = cropOverlay.getBoundingClientRect();
        const curX = e.clientX - rect.left, curY = e.clientY - rect.top;
        selectionBox.style.width = Math.abs(curX - startX) + 'px';
        selectionBox.style.height = Math.abs(curY - startY) + 'px';
        selectionBox.style.left = Math.min(curX, startX) + 'px';
        selectionBox.style.top = Math.min(curY, startY) + 'px';
    });

    cropOverlay.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        const box = selectionBox.getBoundingClientRect();
        if (box.width < 5) return;

        // ç”Ÿæˆè§†è§‰ Canvas (å¸¦æ—‹è½¬å’Œç¼©æ”¾)
        // è¿™ä¸€æ­¥æ˜¯ä¸ºäº†ç¡®ä¿æˆ‘ä»¬æˆªå–çš„å†…å®¹å’Œç”¨æˆ·åœ¨å±å¹•ä¸Šæ¡†é€‰çš„å†…å®¹ä¸€è‡´
        const vCanvas = document.createElement('canvas');
        const vCtx = vCanvas.getContext('2d');
        const vw = video.videoWidth, vh = video.videoHeight;

        // è®¾ç½®ç”»å¸ƒå°ºå¯¸é€‚åº”æ—‹è½¬
        if (currentDeg % 180 !== 0) { vCanvas.width = vh; vCanvas.height = vw; } 
        else { vCanvas.width = vw; vCanvas.height = vh; }

        vCtx.save();
        vCtx.translate(vCanvas.width / 2, vCanvas.height / 2);
        vCtx.rotate(currentDeg * Math.PI / 180);
        vCtx.drawImage(video, -vw / 2, -vh / 2, vw, vh);
        vCtx.restore();

        // è®¡ç®—æ¡†é€‰åæ ‡
        // éš¾ç‚¹ï¼šè§†é¢‘ç°åœ¨è¢« scale ç¼©æ”¾äº†ï¼Œè€Œä¸” object-fit: contain å¯èƒ½åœ¨å†…éƒ¨äº§ç”Ÿäº†åç§»
        // ä½†æˆ‘ä»¬åœ¨ rotateVideo é‡Œæ˜¯æ“ä½œçš„æ•´ä¸ª Video å…ƒç´ ï¼Œé…åˆ container çš„ flex å±…ä¸­
        // æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®— è§†é¢‘çœŸå®æ˜¾ç¤ºå°ºå¯¸ vs åŸå§‹åˆ†è¾¨ç‡ çš„æ¯”ä¾‹
        
        // 1. è·å–è§†é¢‘å…ƒç´ åœ¨å±å¹•ä¸Šçš„å®é™…å¤§å° (åº”ç”¨äº† transform ä¹‹åçš„)
        const videoRect = video.getBoundingClientRect();
        
        // 2. è®¡ç®—ç¼©æ”¾æ¯” (Canvasåˆ†è¾¨ç‡ / å±å¹•æ˜¾ç¤ºå¤§å°)
        const scaleX = vCanvas.width / videoRect.width;
        const scaleY = vCanvas.height / videoRect.height;
        
        // 3. è®¡ç®—åç§»
        const offX = box.left - videoRect.left;
        const offY = box.top - videoRect.top;

        // 4. ç»˜å›¾
        const cropCanvas = document.createElement('canvas');
        cropCanvas.width = box.width * scaleX;
        cropCanvas.height = box.height * scaleY;
        
        cropCanvas.getContext('2d').drawImage(
            vCanvas,
            offX * scaleX, offY * scaleY, cropCanvas.width, cropCanvas.height,
            0, 0, cropCanvas.width, cropCanvas.height
        );
        
        saveImage(cropCanvas.toDataURL(), 'crop');
        toggleCropMode();
    });

    // --- 5. è¾…åŠ©åŠŸèƒ½ ---
    function playPause() { if(video.currentSrc) video.paused ? video.play() : video.pause(); }
    function stepFrame(n) { if(video.currentSrc) video.currentTime += (n * 0.042); }
    function saveImage(dataUrl, prefix) {
        const img = document.createElement('img');
        img.src = dataUrl; img.className = 'preview';
        img.onclick = () => {
            const a = document.createElement('a'); a.href = dataUrl;
            a.download = prefix + '_' + Date.now() + '.png'; a.click();
        };
        document.getElementById('previewArea').prepend(img);
    }
    
    // è¿›åº¦æ¡é€»è¾‘ (ç•¥ä½œç®€åŒ–ï¼Œä¿æŒåŠŸèƒ½)
    video.addEventListener('timeupdate', () => { if (video.duration) progressFill.style.width = (video.currentTime / video.duration) * 100 + '%'; });
    progressWrap.addEventListener('click', (e) => { if (video.duration) video.currentTime = ((e.clientX - progressWrap.getBoundingClientRect().left) / progressWrap.offsetWidth) * video.duration; });
    progressWrap.addEventListener('mousemove', (e) => {
        if (!video.duration) return;
        const x = e.clientX - progressWrap.getBoundingClientRect().left;
        const time = (x / progressWrap.offsetWidth) * video.duration;
        thumbPopup.style.display = 'block'; thumbPopup.style.left = x + 'px';
        thumbTime.innerText = Math.floor(time/60) + ':' + (Math.floor(time%60)<10?'0':'') + Math.floor(time%60);
        if (!ghostSeeking && Math.abs(ghostVideo.currentTime - time) > 1) { ghostSeeking = true; ghostVideo.currentTime = time; }
    });
    progressWrap.addEventListener('mouseleave', () => thumbPopup.style.display = 'none');
    ghostVideo.addEventListener('seeked', () => { thumbCtx.drawImage(ghostVideo, 0, 0, 160, 90); ghostSeeking = false; });

</script>
</body>
</html>