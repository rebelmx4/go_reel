### 核心设计哲学：松耦合与延迟清理

系统的核心理念是**“文件系统为王，元数据为辅”**。物理视频文件的存在是所有功能的基础，而元数据、封面和截图都是附加的“增值数据”。它们之间的关系是松耦合的，通过文件内容的 **Hash** 值进行关联，而非文件路径。

这种设计的优势在于：

1. 
2. **容错性高**：单个文件的丢失或外部改动，不会破坏整个数据库的结构。
3. **性能优先**：日常操作（如列表展示）只进行最基本的文件存在性检查，避免了频繁的、昂贵的深度数据同步。
4. **用户驱动清理**：将彻底的数据清理（垃圾回收）交由用户通过 **F5 刷新** 主动触发，确保了在用户需要时才执行这个相对耗时的操作，保障了平时的流畅体验。

------



### 一致性处理方案：分场景解析

#### 情况一：视频文件在软件外部被【删除】

- 
- **即时影响（列表层面）**：
  - 
  - 当用户切换到任何列表视图（如“最近”、“最新”、“精品”等）时，软件会遍历列表中的文件路径。
  - 如果某个路径对应的文件在磁盘上已不存在，该视频条目将**被静默地从当前显示的列表中剔除**。
  - 用户不会看到任何“已失效”或“损坏”的条目，界面始终保持整洁。
- **残留数据（后台数据）**：
  - 
  - 与该文件关联的元数据（files.json 中的条目）、封面（covers/ 目录下的图片）和截图（screenshots/ 目录下的文件夹）**会暂时保留在磁盘上**，成为“孤儿数据”。
- **最终解决方案**：
  - 
  - 当用户按下 **F5 刷新**时，系统会进行一次深度扫描和比对，识别出这些“孤儿数据”，并将其**彻底清除**。

#### 情况二：视频文件在软件外部被【重命名】或【移动】

- 
- **识别机制**：
  - 
  - 此操作对系统而言，表现为“一个旧路径的文件消失了，一个新路径的文件出现了”。
  - 关键在于，文件的**内容没有改变**，因此其计算出的 **Hash 值保持不变**。
- **处理流程（在 F5 刷新时）**：
  1. 
  2. 系统扫描发现新路径的文件。
  3. 计算其 Hash 值。
  4. 在 files.json 中发现已有条目拥有相同的 Hash 值。
  5. 系统判定这是一个“移动/重命名”操作，而非“删除+新增”。
  6. 它会更新该 Hash 条目下的 paths 数组：移除无效的旧路径，添加有效的新路径。
- **结果**：
  - 
  - 所有与该 Hash 关联的元数据（点赞数、收藏状态、标签）、封面和截图都**完美保留并继承**，不会丢失任何用户产生的数据。

#### 情况三：用户试图播放一个【刚刚被删除】的视频

- 
- **触发场景**：
  - 
  - 列表已经在界面上成功渲染。
  - 用户切换到文件管理器，删除了列表中的某个视频。
  - 用户切回 GoReel，双击刚才那个视频的封面试图播放。
- **处理流程**：
  1. 
  2. 播放器尝试根据文件路径加载视频。
  3. 操作系统返回“文件未找到”错误。
  4. 软件捕获此错误，并立即执行两个操作：
     - 
     - **用户反馈**：在界面左上角弹出一个 **Toast 通知**，提示“文件不存在”或“无法播放”。
     - **界面清理**：从当前显示的列表中**立刻移除**这个无效的视频条目。
- **残留数据**：
  - 
  - 同情况一，其关联的“孤儿数据”仍会暂时保留，等待下一次 F5 刷新时被清理。

------



### F5 刷新的核心任务：数据“垃圾回收” (Garbage Collection)

按下 **F5** 键会触发一个全面的数据同步与清理流程，这是维护数据一致性的关键机制。其具体步骤如下：

1. 
2. **建立快照**：首先，在内存中记录当前 files.json 中所有的文件 Hash。
3. **全盘扫描**：深度扫描所有受监控的视频目录，获取磁盘上所有真实存在的视频文件及其最新的 Hash 值。
4. **数据核对与更新**：
   - 
   - 遍历磁盘上的每一个视频文件。
   - 如果文件的 Hash 存在于 files.json 中，则校对并更新其文件路径（处理“移动/重命名”的情况）。
   - 如果文件的 Hash 不在 files.json 中，则识别为新增文件，纳入可播放列表。
5. **孤儿数据清理**：
   - 
   - 完成上述核对后，files.json 中那些在全盘扫描后依然**没有任何实体文件与之对应**的 Hash 条目，就被确认为“孤儿数据”。
   - 系统会**依次、彻底地删除**这些孤儿 Hash 所对应的一切：
     - 
     - files.json 中的元数据条目。
     - covers/ 目录下的封面图片 ({hash}.webp, {hash}_d.webp)。
     - screenshots/ 目录下对应的整个截图文件夹。
6. **完成刷新**：保存更新后的 files.json，并刷新界面视图。